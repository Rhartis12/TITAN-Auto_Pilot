<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan Global Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-center mb-6 space-x-4">
            <button onclick="switchTab('US')" id="btn-us" class="px-6 py-2 rounded-full font-bold bg-blue-600 text-white transition">üá∫üá∏ US (S&P 500)</button>
            <button onclick="switchTab('KR')" id="btn-kr" class="px-6 py-2 rounded-full font-bold bg-gray-200 text-gray-600 transition">üá∞üá∑ KR (KOSPI)</button>
        </div>

        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800" id="title-text">üöÄ Titan V6.9 Dashboard</h1>
                <p class="text-gray-500" id="update-date">Loading...</p>
            </div>
            <div class="text-right">
                <div class="text-sm font-semibold text-gray-600">Current Regime</div>
                <div id="regime-badge" class="px-4 py-2 rounded-lg text-white font-bold bg-gray-400 mt-1">Loading...</div>
                <div class="text-xs text-gray-400 mt-1" id="macro-z">Z: -</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold text-gray-700 mb-4">‚öñÔ∏è Factor Weights</h3>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold text-gray-700 mb-4">üí∞ Position Calculator</h3>
                <label class="block text-sm font-medium text-gray-700 mb-2">Total Seed Money</label>
                <div class="flex space-x-2">
                    <span id="currency-symbol" class="py-2 text-gray-500 font-bold">$</span>
                    <input type="number" id="seed-input" class="w-full p-2 border rounded mb-4" placeholder="Enter Amount" value="10000">
                </div>
                <button onclick="calculate()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Recalculate</button>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Buy List</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4 border text-left">Ticker</th>
                        <th class="py-2 px-4 border text-left">Sector</th>
                        <th class="py-2 px-4 border text-right">Price</th>
                        <th class="py-2 px-4 border text-right">Weight</th>
                        <th class="py-2 px-4 border text-right bg-blue-50">Allocation</th>
                        <th class="py-2 px-4 border text-right bg-blue-50">Qty</th>
                    </tr>
                </thead>
                <tbody id="port-table"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentMode = 'US'; // US or KR
        let portfolioData = [];
        let chartInstance = null;

        const config = {
            US: { file: 'dashboard_data.json', title: 'üöÄ Titan V6.9 (US)', currency: '$' },
            KR: { file: 'dashboard_data_kr.json', title: 'üêÖ Titan V7.7 (KR)', currency: '‚Ç©' }
        };

        async function switchTab(mode) {
            currentMode = mode;
            // Update Buttons
            document.getElementById('btn-us').className = `px-6 py-2 rounded-full font-bold transition ${mode === 'US' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`;
            document.getElementById('btn-kr').className = `px-6 py-2 rounded-full font-bold transition ${mode === 'KR' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`;
            
            // Update UI Labels
            document.getElementById('title-text').innerText = config[mode].title;
            document.getElementById('currency-symbol').innerText = config[mode].currency;
            document.getElementById('seed-input').value = mode === 'US' ? 10000 : 10000000; // Default Seed

            await loadData();
        }

        async function loadData() {
            try {
                const response = await fetch(config[currentMode].file);
                if (!response.ok) throw new Error("Data not found");
                const data = await response.json();
                
                // Header
                document.getElementById('update-date').innerText = `Last Updated: ${data.date}`;
                const regimeEl = document.getElementById('regime-badge');
                regimeEl.innerText = data.regime.status;
                document.getElementById('macro-z').innerText = `Rate Z: ${data.regime.rate_z} | CPI Z: ${data.regime.cpi_z}`;

                // Color Coding
                let colorClass = "bg-green-500";
                if(data.regime.status.includes("Stagflation")) colorClass = "bg-red-500";
                else if(data.regime.status.includes("Recession")) colorClass = "bg-blue-500";
                else if(data.regime.status.includes("Overheat")) colorClass = "bg-orange-500";
                regimeEl.className = `px-4 py-2 rounded-lg text-white font-bold mt-1 ${colorClass}`;

                // Chart
                const ctx = document.getElementById('weightChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Value', 'Momentum', 'LowVol', 'Quality'],
                        datasets: [{
                            data: [data.weights.VALUE, data.weights.MOM, data.weights.LOWVOL, data.weights.QUALITY],
                            backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                portfolioData = data.portfolio;
                calculate(); 

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('update-date').innerText = "Data file not found. Run the script first.";
            }
        }

        function calculate() {
            const seed = parseFloat(document.getElementById('seed-input').value) || 0;
            const tbody = document.getElementById('port-table');
            tbody.innerHTML = '';
            const curr = config[currentMode].currency;

            portfolioData.forEach(item => {
                const allocAmt = seed * item.weight;
                const shares = Math.floor(allocAmt / item.price);
                const priceStr = item.price.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                const allocStr = allocAmt.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

                const tr = `
                    <tr class="hover:bg-gray-50 border-b last:border-0">
                        <td class="py-3 px-4 font-bold text-blue-600">${item.ticker}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${item.sector}</td>
                        <td class="py-3 px-4 text-right">${curr}${priceStr}</td>
                        <td class="py-3 px-4 text-right text-gray-500">${(item.weight * 100).toFixed(1)}%</td>
                        <td class="py-3 px-4 text-right font-semibold bg-blue-50/50 text-blue-800">${curr}${allocStr}</td>
                        <td class="py-3 px-4 text-right font-bold bg-blue-50 text-blue-900">${shares}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }

        // Init
        switchTab('US');
    </script>
</body>
</html>
